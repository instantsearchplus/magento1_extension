<?php
$store_id = Mage::app()->getStore()->getStoreId();
$config = Mage::getModel('autocompleteplus_autosuggest/config');
$uuid = $config->getUUID();
$query = htmlentities(Mage::app()->getRequest()->getParam('q'), ENT_QUOTES);

?>
<?php if(!$config->getSerpV2($store_id)): ?>
    <!-- <div id="isp_search_result_page"></div> -->

    <script>
        var __isp_fulltext_search_obj = {
            uuid: "<?php echo $this->escapeHtml($config->getUUID()); ?>",
            store_id: <?php echo $this->escapeHtml($store_id); ?>,
            query: "<?php echo $this->escapeHtml($query); ?>",
            formkey: "<?php echo Mage::getSingleton('core/session')->getFormKey(); ?>"
        };
    </script>
    <?php
    $helper = Mage::helper('autocompleteplus_autosuggest');

    $html=Mage::app()->getCacheInstance()->load('autocomplete_template_serp');

    if (!$html) {
        $server_url = $helper->getServerUrl();
        $url = $server_url .
            '/ma_load_search_page?isp_platform=magento&r=002&uuid=' .
            $config->getUUID() . '&store_id=' . $store_id;
        $resp = $helper->sendCurl($url);
        $response_json = json_decode($resp);
        $html = $response_json->html;

        Mage::app()->getCacheInstance()
            ->save(
                $html,
                'autocomplete_template_serp',
                array("autocomplete_cache"),
                60
            );

    }

    echo $html;
    ?>
<?php else: ?>
    <?php
    try {
        $cv = $config->getCustomValues($store_id);
        $cv_j = json_decode($cv);
    } catch (Exception $e) {
        $cv_j = (object) array(
            'config'=>'',
            'serp_css'=>''
        );
    }
    ?>
    <!---
    Auto-generated by Fast Simon.
    DO NOT EDIT this as this file can be re-written at any time.
    --->

    <div id="fast-config" style="display: none"><?php echo $cv_j->config; ?></div>
    <style id="fast-serp-css"><?php echo $cv_j->serp_css; ?></style>
    <script class="fast-simon-script">
        var STORE_UUID = "<?php echo $uuid;?>";
        var STORE_ID = Number("<?php echo $store_id;?>");
        var FAST_SEARCH_HANDLE = "instantsearchplus/result";
    </script>
    <div id="fast-simon-serp-app" style="display:block;color: initial;background: initial"></div>
    <script>
        var script = document.createElement("script");
        script.src = "https://fastsimon-grid.akamaized.net/init.min.js?v=${Date.now()}";
        document.body.appendChild(script);
    </script>
<?php endif;?>
